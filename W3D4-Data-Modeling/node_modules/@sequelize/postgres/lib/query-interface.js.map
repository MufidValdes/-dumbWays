{
  "version": 3,
  "sources": ["../src/query-interface.js"],
  "sourcesContent": ["'use strict';\n\nimport { DataTypes, QueryTypes } from '@sequelize/core';\nimport { PostgresQueryInterfaceTypescript } from './query-interface-typescript.internal.js';\n\n/**\n * The interface that Sequelize uses to talk with Postgres database\n */\nexport class PostgresQueryInterface extends PostgresQueryInterfaceTypescript {\n  /**\n   * Ensure enum and their values.\n   *\n   * @param {string} tableName  Name of table to create\n   * @param {object} attributes Object representing a list of normalized table attributes\n   * @param {object} [options]\n   * @param {Model}  [model]\n   *\n   * @protected\n   */\n  async ensureEnums(tableName, attributes, options, model) {\n    const keys = Object.keys(attributes);\n    const keyLen = keys.length;\n\n    let sql = '';\n    let promises = [];\n    let i = 0;\n\n    for (i = 0; i < keyLen; i++) {\n      const attribute = attributes[keys[i]];\n      const type = attribute.type;\n\n      if (\n        type instanceof DataTypes.ENUM ||\n        (type instanceof DataTypes.ARRAY && type.options.type instanceof DataTypes.ENUM) // ARRAY sub type is ENUM\n      ) {\n        sql = this.queryGenerator.pgListEnums(tableName, attribute.field || keys[i], options);\n        promises.push(\n          this.sequelize.queryRaw(sql, {\n            ...options,\n            plain: true,\n            raw: true,\n            type: QueryTypes.SELECT,\n          }),\n        );\n      }\n    }\n\n    const results = await Promise.all(promises);\n    promises = [];\n    let enumIdx = 0;\n\n    // This little function allows us to re-use the same code that prepends or appends new value to enum array\n    const addEnumValue = (\n      field,\n      value,\n      relativeValue,\n      position = 'before',\n      spliceStart = promises.length,\n    ) => {\n      const valueOptions = { ...options };\n      valueOptions.before = null;\n      valueOptions.after = null;\n\n      switch (position) {\n        case 'after':\n          valueOptions.after = relativeValue;\n          break;\n        case 'before':\n        default:\n          valueOptions.before = relativeValue;\n          break;\n      }\n\n      promises.splice(spliceStart, 0, () => {\n        return this.sequelize.queryRaw(\n          this.queryGenerator.pgEnumAdd(tableName, field, value, valueOptions),\n          valueOptions,\n        );\n      });\n    };\n\n    for (i = 0; i < keyLen; i++) {\n      const attribute = attributes[keys[i]];\n      const type = attribute.type;\n      const enumType = type instanceof DataTypes.ARRAY ? type.options.type : type;\n      const field = attribute.field || keys[i];\n\n      if (\n        type instanceof DataTypes.ENUM ||\n        (type instanceof DataTypes.ARRAY && enumType instanceof DataTypes.ENUM) // ARRAY sub type is ENUM\n      ) {\n        // If the enum type doesn't exist then create it\n        if (!results[enumIdx]) {\n          promises.push(() => {\n            return this.sequelize.queryRaw(\n              this.queryGenerator.pgEnum(tableName, field, enumType, options),\n              { ...options, raw: true },\n            );\n          });\n        } else if (Boolean(results[enumIdx]) && Boolean(model)) {\n          const enumVals = this.queryGenerator.fromArray(results[enumIdx].enum_value);\n          const vals = enumType.options.values;\n\n          // Going through already existing values allows us to make queries that depend on those values\n          // We will prepend all new values between the old ones, but keep in mind - we can't change order of already existing values\n          // Then we append the rest of new values AFTER the latest already existing value\n          // E.g.: [1,2] -> [0,2,1] ==> [1,0,2]\n          // E.g.: [1,2,3] -> [2,1,3,4] ==> [1,2,3,4]\n          // E.g.: [1] -> [0,2,3] ==> [1,0,2,3]\n          let lastOldEnumValue;\n          let rightestPosition = -1;\n          for (let oldIndex = 0; oldIndex < enumVals.length; oldIndex++) {\n            const enumVal = enumVals[oldIndex];\n            const newIdx = vals.indexOf(enumVal);\n            lastOldEnumValue = enumVal;\n\n            if (newIdx === -1) {\n              continue;\n            }\n\n            const newValuesBefore = vals.slice(0, newIdx);\n            const promisesLength = promises.length;\n            // we go in reverse order so we could stop when we meet old value\n            for (let reverseIdx = newValuesBefore.length - 1; reverseIdx >= 0; reverseIdx--) {\n              if (enumVals.includes(newValuesBefore[reverseIdx])) {\n                break;\n              }\n\n              addEnumValue(\n                field,\n                newValuesBefore[reverseIdx],\n                lastOldEnumValue,\n                'before',\n                promisesLength,\n              );\n            }\n\n            // we detect the most 'right' position of old value in new enum array so we can append new values to it\n            if (newIdx > rightestPosition) {\n              rightestPosition = newIdx;\n            }\n          }\n\n          if (lastOldEnumValue && rightestPosition < vals.length - 1) {\n            const remainingEnumValues = vals.slice(rightestPosition + 1);\n            for (let reverseIdx = remainingEnumValues.length - 1; reverseIdx >= 0; reverseIdx--) {\n              addEnumValue(field, remainingEnumValues[reverseIdx], lastOldEnumValue, 'after');\n            }\n          }\n\n          enumIdx++;\n        }\n      }\n    }\n\n    const result = await promises.reduce(\n      async (promise, asyncFunction) => await asyncFunction(await promise),\n      Promise.resolve(),\n    );\n\n    // If ENUM processed, then refresh OIDs\n    if (promises.length > 0) {\n      await this.sequelize.dialect.connectionManager.refreshDynamicOids();\n    }\n\n    return result;\n  }\n\n  /**\n   * Drop specified enum from database (Postgres only)\n   *\n   * @param {string} [enumName]  Enum name to drop\n   * @param {object} options Query options\n   *\n   * @returns {Promise}\n   */\n  async dropEnum(enumName, options) {\n    options ||= {};\n\n    return this.sequelize.queryRaw(\n      this.queryGenerator.pgEnumDrop(null, null, this.queryGenerator.quoteIdentifier(enumName)),\n      { ...options, raw: true },\n    );\n  }\n\n  /**\n   * Drop all enums from database (Postgres only)\n   *\n   * @param {object} options Query options\n   *\n   * @returns {Promise}\n   */\n  async dropAllEnums(options) {\n    options ||= {};\n\n    const enums = await this.pgListEnums(null, options);\n\n    return await Promise.all(\n      enums.map(result =>\n        this.sequelize.queryRaw(\n          this.queryGenerator.pgEnumDrop(\n            null,\n            null,\n            this.queryGenerator.quoteIdentifier(result.enum_name),\n          ),\n          { ...options, raw: true },\n        ),\n      ),\n    );\n  }\n\n  /**\n   * List all enums (Postgres only)\n   *\n   * @param {string} [tableName]  Table whose enum to list\n   * @param {object} [options]    Query options\n   *\n   * @returns {Promise}\n   */\n  async pgListEnums(tableName, options) {\n    options ||= {};\n    const sql = this.queryGenerator.pgListEnums(tableName);\n\n    return this.sequelize.queryRaw(sql, {\n      ...options,\n      plain: false,\n      raw: true,\n      type: QueryTypes.SELECT,\n    });\n  }\n\n  /**\n   * Since postgres has a special case for enums, we should drop the related\n   * enum type within the table and attribute\n   *\n   * @override\n   */\n  async dropTable(tableName, options) {\n    await super.dropTable(tableName, options);\n    const promises = [];\n    // TODO: we support receiving the model class instead of getting it from modelManager. More than one model can use the same table.\n    const model = this.sequelize.models.find(model =>\n      this.queryGenerator.isSameTable(model.table, tableName),\n    );\n\n    if (!model) {\n      // Do nothing when model is not available\n      return;\n    }\n\n    const getTableName =\n      (!options || !options.schema || options.schema === 'public' ? '' : `${options.schema}_`) +\n      tableName;\n\n    const attributes = model.modelDefinition.attributes;\n\n    for (const attribute of attributes.values()) {\n      if (!(attribute.type instanceof DataTypes.ENUM)) {\n        continue;\n      }\n\n      const sql = this.queryGenerator.pgEnumDrop(getTableName, attribute.attributeName);\n      promises.push(\n        this.sequelize.queryRaw(sql, {\n          ...options,\n          raw: true,\n          supportsSearchPath: false,\n        }),\n      );\n    }\n\n    await Promise.all(promises);\n  }\n}\n"],
  "mappings": "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",
  "names": ["model"]
}
